/// # `first!`ï¼šåŒ¹é…é¦–ä¸ªåˆ¤æ®ï¼Œå¹¶è¿”å›å…¶å€¼
/// * ğŸ¯ç”¨äºç®€å†™ã€Œæˆªæ–­æ€§åˆ¤æ–­ã€ç»“æ„
///   * ğŸ“Œå¯ç”¨äºç®€å†™`if-else if-else`ã€Œä¼˜å…ˆåˆ†æ”¯ã€ç»“æ„
///   * ğŸ“Œå¯ç”¨äºç®€å†™`match 0 {_ if XXX => Z1, _ if YYY => Z2, _ => ELSE}`ã€Œä¼ªä¼˜å…ˆåˆ†æ”¯ã€ç»“æ„
///
/// ğŸ“Rustçš„ã€Œè§„åˆ™å®ã€å¹¶ä¸èƒ½è¢«è§†ä½œä¸ºä¸€ä¸ªç±»ä¼¼ã€Œå˜é‡ã€ã€Œå‡½æ•°ã€ä¹‹ç±»èƒ½å¯¼å‡ºçš„é‡
/// * âŒæ— æ³•ä½¿ç”¨å¸¸è§„çš„`pub`ï¼ˆç›¸å½“äºJuliaçš„`export`ï¼‰å¯¼å‡º
///   * ğŸ“Œéœ€è¦ä½¿ç”¨`#[macro_export]`å¯¼å‡º
///     * ğŸ“å¯é€‰çš„[`local_inner_macros`]ï¼šå¯¼å‡ºåœ¨å½“å‰æ¨¡å—ä¸­å®šä¹‰çš„ã€Œå†…éƒ¨å®ã€(inner macro)ã€‚
///       * å†…éƒ¨å®ï¼šä»…åœ¨å…¶ä»–å®çš„å®šä¹‰ä½“ä¸­ä½¿ç”¨çš„å®
/// * â—éœ€è¦åœ¨crateå±‚çº§å¯¼å…¥ï¼Œè€Œéåœ¨å®šä¹‰å®çš„æ¨¡å—ä¸­å¯¼å…¥
/// * ğŸ“ä½¿ç”¨`#[cfg(not(test))]`æ ‡æ³¨ã€Œéæµ‹è¯•ã€
///   * ğŸ¯å¯é˜²æ­¢ã€Œå®šä¹‰ä¹‹å‰æµ‹è¯•å®ã€å¯¼è‡´çš„ã€Œæ–‡æ¡£æµ‹è¯•ï¼ˆdoc testï¼‰å¤±è´¥ã€
///   * â—ä½†ä¹Ÿä¼šå¯¼è‡´åœ¨åˆ«çš„æµ‹è¯•ä¸­ç”¨ä¸äº†
///   * ğŸ“ŒSOLUTIONï¼šåœ¨æ–‡æ¡£ä»£ç å—ä¸­å¼•å…¥`use ã€åº“åã€‘::*;`
///     * â—ä¸èƒ½ç”¨`crate` | `help: consider importing this macro`
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::first;
/// fn see(v: &str) -> &str {
///     // åŒ¹é…ä¸€ä¸ªæ— æ„ä¹‰çš„å€¼ï¼Œä½¿ç”¨åŒ¹é…å®ˆå«æ¥ç¡®å®šã€Œå”¯ä¸€è¿›å…¥çš„åˆ†æ”¯ã€
///     first! {
///         v.is_empty() => "ç©ºçš„ï¼",
///         v.starts_with("0") => "ä»¥é›¶å¼€å¤´ï¼",
///         v.starts_with("1") => "ä»¥ä¸€å¼€å¤´ï¼",
///         v.starts_with("2") => "ä»¥äºŒå¼€å¤´ï¼",
///         v.len() > 5 => "è¶…é•¿å­—ç¬¦ä¸²ï¼",
///         v.starts_with("3") => "ä»¥ä¸‰å¼€å¤´ï¼",
///         _ => "è¿™å•¥ç©æ„â€¦",
///     }
/// }
/// ```
///
/// å°†è¢«è½¬æ¢æˆ
///
/// ```rust
/// fn see(v: &str) -> &str {
///    match 0 {
///         _ if v.is_empty() => "ç©ºçš„ï¼",
///         _ if v.starts_with("0") => "ä»¥é›¶å¼€å¤´ï¼",
///         _ if v.starts_with("1") => "ä»¥ä¸€å¼€å¤´ï¼",
///         _ if v.starts_with("2") => "ä»¥äºŒå¼€å¤´ï¼",
///         _ if v.len() > 5 => "è¶…é•¿å­—ç¬¦ä¸²ï¼",
///         _ if v.starts_with("3") => "ä»¥ä¸‰å¼€å¤´ï¼",
///         _ => "è¿™å•¥ç©æ„â€¦",
///     }
/// }
/// ```
///
/// æ­¤`match`è¡¨è¾¾å¼ç­‰ä»·äºï¼š
///
/// ```rust
/// fn see(v: &str) -> &str {
///     if v.is_empty() {
///        "ç©ºçš„ï¼"
///     } else if v.starts_with("0") {
///         "ä»¥é›¶å¼€å¤´ï¼"
///     } else if v.starts_with("1") {
///         "ä»¥ä¸€å¼€å¤´ï¼"
///     } else if v.starts_with("2") {
///         "ä»¥äºŒå¼€å¤´ï¼"
///     } else if v.len() > 5 {
///         "è¶…é•¿å­—ç¬¦ä¸²ï¼"
///     } else if v.starts_with("3") {
///         "ä»¥ä¸‰å¼€å¤´ï¼"
///     } else {
///         "è¿™å•¥ç©æ„â€¦"
///     }
/// }
/// ```
#[macro_export]
macro_rules! first {
    // ç¬¬ä¸€æ¡è§„åˆ™ï¼šæœ€åä¸€æ¡ä¿ç•™`_`
    { // * ğŸ“â†å·¦è¾¹çš„æ‹¬å·åªæ˜¯æ ‡æ³¨ã€Œæ¨èç”¨æ‹¬å¼§ã€è€Œå¯¹å®é™…è§£ææ— é™å®šä½œç”¨
        // â†“å‰è¾¹æ ‡æ³¨ç‰‡æ®µä»¥ã€Œ,ã€é‡å¤    åè¾¹åˆ†éš”è¡¨è¾¾å¼â†“
        $($guardian:expr => $value:expr),* ,
        // â†“å¯¹å­—é¢æ ‡è¯†ã€Œ_ã€æ— éœ€`$(...)`å¼•ç”¨
        _ => $value_else:expr $(,)?
    } => {
        // ğŸ’­å®é™…ä¸Šè½¬æ¢ä¸º`if-else if-else`äº¦éä¸å¯
        // åŒ¹é…æ— ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡`0`
        match 0 {
            // â†“è¿™ä¸€è¡Œæ’å…¥åºåˆ—
            $(_ if $guardian => $value,)*
            _ => $value_else,
        }
    }; // ! â†è®°å¾—åˆ†å·åˆ†éš”
    // ã€Œæœ€åä¸€æ¡ç›´æ¥å†™ã€çš„è§„åˆ™ä¼šå¯¼è‡´ã€Œè¡¨è¾¾å¼æ­§ä¹‰ã€
    // ğŸ“„``local ambiguity when calling macro `first`: multiple parsing options: built-in NTs expr ('value_else') or expr ('guardian').``
}

/// # `show!`ï¼šå¤ç°Juliaçš„`@show`
/// * ğŸ¯æ¨¡æ‹ŸJuliaä¸­å¸¸ç”¨çš„å®`@show è¡¨è¾¾å¼`
///   * ä¸Julia`@show(è¡¨è¾¾å¼)`ç­‰ä»· | Juliaçš„è¿˜æ›´å®½æ¾ï¼Œä¸å¼ºåˆ¶æ‹¬å·
/// * ğŸ“Œæ ¸å¿ƒï¼šæ‰“å°`è¡¨è¾¾å¼ = å€¼`ï¼Œå¹¶è¿”å›è¡¨è¾¾å¼çš„å€¼
/// * ğŸ“ä½¿ç”¨`#[cfg(not(test))]`æ ‡æ³¨ã€Œéæµ‹è¯•ã€
///   * ğŸ¯é˜²æ­¢ã€Œå®šä¹‰ä¹‹å‰æµ‹è¯•å®ã€å¯¼è‡´çš„ã€Œæ–‡æ¡£æµ‹è¯•ï¼ˆdoc testï¼‰å¤±è´¥ã€
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::show;
/// fn see<'a>(v: &'a str, v2: &'a str) -> (&'a str, &'a str) {
///     // ç”¨`show!`æ‰“å°`v`ã€`v2`ï¼Œä¸è¿”å›å€¼
///     show!(&v, &v2;);
///     // ç”¨`show!`æ‰“å°`v`ï¼Œå¹¶è¿”å›å…¶å€¼
///     show!(v, v2)
/// }
/// ```
///
/// å°†è¢«è½¬æ¢ä¸º
///
/// ```rust
/// fn see<'a>(v: &'a str, v2: &'a str) -> (&'a str, &'a str) {
///     // ç”¨`show!`æ‰“å°`v`ã€`v2`ï¼Œä¸è¿”å›å€¼
///     println!("{} = {:?}", "&v", (&v));
///     println!("{} = {:?}", "&v2", (&v2));
///     // ç”¨`show!`æ‰“å°`v`ï¼Œå¹¶è¿”å›å…¶å€¼
///     (
///         {
///             let value = v;
///             println!("{} = {:?}", "v", value);
///             value
///         },
///         {
///             let value = v2;
///             println!("{} = {:?}", "v2", value);
///             value
///         },
///     )
/// }
/// ```
///
/// è°ƒç”¨`see("æˆ‘æ˜¯ä¸€ä¸ªå€¼", "æˆ‘æ˜¯å¦ä¸€ä¸ªå€¼")`å°†è¾“å‡º
///
/// ```plaintext
/// &v = "æˆ‘æ˜¯ä¸€ä¸ªå€¼"
/// &v2 = "æˆ‘æ˜¯å¦ä¸€ä¸ªå€¼"
/// v = "æˆ‘æ˜¯ä¸€ä¸ªå€¼"
/// v2 = "æˆ‘æ˜¯å¦ä¸€ä¸ªå€¼"
/// ```
///
/// å¹¶è¿”å›`("æˆ‘æ˜¯ä¸€ä¸ªå€¼", "æˆ‘æ˜¯å¦ä¸€ä¸ªå€¼")`
#[macro_export]
macro_rules! show {
    // å•å‚æ•°ï¼šæ±‚å€¼ã€æ‰“å°ã€è¿”å›
    ($e:expr) => {
        {
            // æ±‚å€¼ | å†…éƒ¨èµ‹å€¼
            let value = $e;
            // æ‰“å°
            println!("{} = {:?}", stringify!($e), value);
            // è¿”å› | ä¸Šäº¤å€¼ï¼ˆæ‰€æœ‰æƒï¼‰
            value
        }
    };
    // å•å‚æ•°butä¸è¿”å›ï¼šæ±‚å€¼ã€æ‰“å°
    // * â†“æ³¨æ„ï¼šæœ«å°¾ä½¿ç”¨äº†åˆ†å·
    ($e:expr;) => {
        // ç›´æ¥æ±‚å€¼å¹¶æ‰“å°
        println!("{} = {:?}", stringify!($e), $e)
    };
    // å¤šå‚æ•°&è¿”å›ï¼šåˆ†åˆ«æ±‚å€¼&æ‰“å°ï¼Œè¾“å‡ºåˆ°å…ƒç»„
    ($($e:expr),+ $(,)?) => {
        // æ„é€ å…ƒç»„
        ( $( show!($e) ),* )
    };
    // å¤šå‚æ•°&ä¸è¿”å›ï¼šåˆ†åˆ«æ±‚å€¼&æ‰“å°
    ($($e:expr),+ $(,)?;) => {
        // ç›´æ¥ä¸æ„é€ å…ƒç»„
        $( show!($e;) );*;
    };
}

#[allow(clippy::test_attr_in_doctest)] // * ğŸ“å‘Šè¯‰Clippyã€Œè¿™åªæ˜¯ç”¨æ¥ç”Ÿæˆå•å…ƒæµ‹è¯•çš„ç¤ºä¾‹ï¼Œå¹¶éè¦è¿è¡Œæµ‹è¯•ã€
/// # è¾…åŠ©ç”¨æµ‹è¯•å®/æ‰¹é‡æ·»åŠ å¤±è´¥æµ‹è¯•
///
/// * å¯æå¤§å‡è½»æ·»åŠ `should_panic`çš„ä»£ç é‡
///
/// ! ğŸ“`, $(,)?`è¿™é‡Œçš„ã€Œ,ã€ä»£è¡¨çš„ä¸æ˜¯ã€Œåˆ†éš”è¡¨è¾¾å¼ã€ï¼Œè€Œæ˜¯ã€Œæ¨¡å¼ä¸­çš„`,`ã€
/// * æ•…åº”å»é™¤è¿™å‰è¾¹çš„ã€Œ,ã€
///
/// ç”¨æ³•ï¼š
///
/// ```rust
/// use enum_narsese::fail_tests;
/// // ä¸€èˆ¬å½¢å¼ï¼šå‡½æ•°å {ä»£ç }
/// fail_tests! {
///     å¤±è´¥æµ‹è¯•çš„å‡½æ•°å {
///         // ä¼šå¯¼è‡´panicçš„ä»£ç 
///     }
///     // ... å…è®¸å¤šæ¡
/// }
/// // äº¦å¯ï¼šå‡½æ•°å è¡¨è¾¾å¼/è¯­å¥
/// fail_tests! {
///     å¤±è´¥æµ‹è¯•çš„å‡½æ•°å if true {panic!("ä¼šå¯¼è‡´panicçš„è¡¨è¾¾å¼")} else {};
///     // ... å…è®¸å¤šæ¡
/// }
/// fail_tests! {
///     å¤±è´¥æµ‹è¯•çš„å‡½æ•°å panic!("ä¼šå¯¼è‡´panicçš„è¯­å¥");
///     // ... å…è®¸å¤šæ¡
/// }
/// ```
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::fail_tests;
/// fail_tests! {
///     fail {
///         panic!("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•")
///     }
///     fail2 {
///         panic!("è¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•")
///     }
/// }
/// ```
///
/// å°†è¢«è½¬æ¢ä¸º
///
/// ```rust
/// #[test]
/// #[should_panic]
/// fn fail() {
///     panic!("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•")
/// }
///
/// #[test]
/// #[should_panic]
/// fn fail2() {
///     panic!("è¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•")
/// }
/// ```
#[macro_export]
macro_rules! fail_tests {
    // åŒ¹é…ä»£ç å—
    ($($name:ident $code:block)* $(,)?) => {
        $(
            /// å¤±è´¥æµ‹è¯•_$name
            #[test]
            #[should_panic]
            fn $name() {
                $code
            }
        )*
    };
    // åŒ¹é…è¡¨è¾¾å¼
    ($($name:ident $code:expr;)* $(,)?) => {
        $(
            /// å¤±è´¥æµ‹è¯•_$name
            #[test]
            #[should_panic]
            fn $name() {
                $code; // â† ç”¨åˆ†å·åˆ†éš”
            }
        )*
    };
    // åŒ¹é…è¯­å¥
    ($($name:ident $code:stmt;)* $(,)?) => {
        $(
            /// å¤±è´¥æµ‹è¯•_$name
            #[test]
            #[should_panic]
            fn $name() {
                $code
            }
        )*
    };
}

#[macro_export]
macro_rules! assert_eqs {
    {
        $($left:expr => $right:expr $(,)?)*
    } => {
        $(
            assert_eq!($left, $right);
        )*
    };
}

/// ç”¨äºç®€åŒ–ã€Œè¿ç»­è¿½åŠ å­—ç¬¦ä¸²ã€çš„å®
/// * ğŸ¯æœ€åˆç”¨äºã€Œå­—ç¬¦ä¸²æ ¼å¼åŒ–ã€ç®—æ³•ä¸­
/// * ğŸš©ç”¨æ³•ï¼š`push_str!(è¦è¿½åŠ å…¥çš„å­—ç¬¦ä¸²; å¾…è¿½åŠ è¡¨è¾¾å¼1, å¾…è¿½åŠ è¡¨è¾¾å¼2, ...)`
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::push_str;
/// let mut s = String::new();
/// push_str!(
///     &mut s;
///     "è¿™",
///     "æ˜¯",
///     "å¯ä»¥è¢«",
///     &String::from("è¿ç»­æ·»åŠ "),
///     "\u{7684}",
/// );
/// assert_eq!(s, "è¿™æ˜¯å¯ä»¥è¢«è¿ç»­æ·»åŠ çš„");
/// ```
#[macro_export]
macro_rules! push_str {
    {$out:expr; $($ex:expr),* $(,)?} => {
        {
            $(
                $out.push_str($ex)
            );*
        }
    };
}

/// ç”¨äºå°†ã€Œæµå¼è¿½åŠ ã€æ•æ‰è½¬æ¢æˆã€Œå›ºå®šè¿”å›å€¼ã€
/// * ğŸ¯é¦–æ¬¡åº”ç”¨äºã€ŒåŸºäº[`String::push_str`]åŠ¨æ€è¿½åŠ äº§ç”Ÿå­—ç¬¦ä¸²ã€ä¸ã€Œç›´æ¥è¿”å›å­—ç¬¦ä¸²ã€çš„è½¬æ¢ä¸­
///
/// # Example
///
/// ```rust
/// use enum_narsese::catch_flow;
///
/// fn append(out: &mut String) {
///     out.push_str("hello, ");
///     out.push_str("world!");
/// }
///
/// let caught = catch_flow!(append;);
/// assert_eq!(caught, "hello, world!");
/// ```
#[macro_export]
macro_rules! catch_flow {
    ( $($path:ident).+ ; $($arg:tt)* ) => {
        {
            let mut s = String::new();
            $($path).+(&mut s, $($arg)*);
            s
        }
    };
}

/// æ›´é€šç”¨çš„ã€Œå‡½æ•°å‚æ•°å¼ é‡å±•å¼€ã€å®
/// * ğŸ¯ç”¨äºæœ€ç»ˆç‰ˆç®€åŒ–ä¸€ç³»åˆ—ã€Œç¬›å¡å°”ç§¯å¼ç»„åˆè°ƒç”¨ã€
/// * ğŸš©ã€2024-03-09 15:01:24ã€‘ä¸ã€Œå‡½æ•°å‚æ•°çŸ©é˜µå±•å¼€ã€å®åˆå¹¶
///   * ğŸ“Œåè€…ï¼ˆçŸ©é˜µï¼‰å¯çœ‹ä½œã€ŒäºŒç»´å¼ é‡ã€
/// * âš ï¸å¯¹ã€Œå†…éƒ¨è½¬æ¢ã€`@inner`çš„è§„å®šæ€§çº¦æŸï¼š
///   * ğŸš©ç»Ÿä¸€ä½¿ç”¨æ–¹æ‹¬å·ï¼Œé¿å…ã€Œåœ†æ‹¬å·â†’è¡¨è¾¾å¼å€¼ã€çš„æ­§ä¹‰
///   * ğŸš©ç»Ÿä¸€ä½¿ç”¨é€—å·åˆ†éš”ï¼ˆå¼ºåˆ¶å°¾åé€—å·ï¼‰ï¼Œé¿å…ã€Œè¿ç»­åœ†æ‹¬å·â†’å‡½æ•°è°ƒç”¨ã€çš„æ­§ä¹‰
///
/// # Example
///
/// ```rust
/// use enum_narsese::f_tensor;
/// fn add(a: i32, b: i32) -> i32 {
///     a + b
/// }
/// fn add3(a: i32, b: i32, c: i32) -> i32 {
///     a + b + c
/// }
///
///  // fallbackæƒ…å†µ
/// let m = f_tensor!(@inner [add] [1, 2,]);
/// assert_eq!(m, 3);
///
///  // fallbackæƒ…å†µ 2
/// let m = f_tensor!(@inner [add] [1, 2,] []);
/// assert_eq!(m, 3);
///
///  // æ­£å¸¸æƒ…å†µ
/// let m1 = f_tensor![add [1 2] [3 4 5]];
/// let m2 = f_tensor![add3; 1 2; 3 4; 5 6];
/// // ğŸ“Œâ†“æ­¤å¤„å¯¹ã€Œæ‹¬å·è¡¨è¾¾å¼ã€å¯ç”¨é€—å·æ˜ç¡®åˆ†éš”ï¼Œä»¥é¿å…ã€Œå‡½æ•°è°ƒç”¨ã€æ­§ä¹‰
/// let m3 = f_tensor![add3 [(2-1), (1+1)] [3 4] [5 6]];
///
/// assert_eq!(m1, [[4, 5, 6], [5, 6, 7]]);
/// assert_eq!(
///     m2,
///     // â†“å±•å¼€ç»“æœ
///     [
///         [[1 + 3 + 5, 1 + 3 + 6], [1 + 4 + 5, 1 + 4 + 6]],
///         [[2 + 3 + 5, 2 + 3 + 6], [2 + 4 + 5, 2 + 4 + 6]],
///     ]
/// );
/// // â†“è®¡ç®—ç»“æœ
/// assert_eq!(m3, [[[9, 10], [10, 11]], [[10, 11], [11, 12]],]);
/// ```
///
/// # Experiences
///
/// * ğŸ“ä½¿ç”¨ã€Œå‰ç¼€ç‰¹æ®Šæ ‡è¯†ç¬¦ã€æ§åˆ¶å®åŒ¹é…æ—¶çš„åˆ†æ´¾è·¯å¾„
///   * ğŸ’­æ­¤ä¸¾ç‰¹åˆ«åƒJuliaçš„å¤šåˆ†æ´¾ç³»ç»Ÿ
/// * ğŸ“æ¶‰åŠã€ŒåµŒå¥—ç¬›å¡å°”ç§¯å±•å¼€ã€æ—¶ï¼ŒæŠŠå…¶å®ƒå˜é‡éƒ½å˜æˆä¸€ä¸ªç»´åº¦ï¼Œåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­åªå±•å¼€ä¸€ä¸ªç»´åº¦
///   * ğŸš©æºè‡ªGitHub Issueçš„æ–¹æ³•
///     * 1 å…ˆä½¿ç”¨ã€Œæ•°ç»„ã€ä¹‹ç±»çš„åŒ…è£…æˆä¸€ä¸ªä»¤ç‰Œæ ‘ï¼ˆttï¼‰
///     * 2 å±•å¼€å¦ä¸€ä¸ªç»´åº¦
///     * 3 å†å°†åŸå…ˆåŒ…è£…çš„ç»´åº¦è§£åŒ…
///
/// # References
///
/// * ğŸ”—å®å°å†Œã€Œä½¿ç”¨`@`æ ‡è¯†å­åˆ†æ´¾ã€<https://www.bookstack.cn/read/DaseinPhaos-tlborm-chinese/aeg-ook.md>
/// * ğŸ”—å¼€å‘è€…è®ºå›ï¼š<https://users.rust-lang.org/t/why-is-the-innermost-meta-variable-expansion-impacted-by-the-outmost-one/99099/4>
/// * ğŸ”—GitHub Issueï¼š<https://github.com/rust-lang/rust/issues/96184>
#[macro_export]
macro_rules! f_tensor {
    // å…¥å£/ç©ºæ ¼åˆ†å·å½¢å¼ | å¯é€‰é€—å·è¿›è¡Œæ— æ­§ä¹‰åˆ†éš”
    // * f_tensor![f; 1 2 3; 4 5 6]
    [
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆæ ‡è¯†ç¬¦ï¼‰
        $($path:ident).+;
        // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ—
        $($($arg:expr $(,)?)+);+ $(;)?
    ] => {
        // * 0 åŒ…è£…åè¾¹çš„å‚æ•°åˆ°æ•°ç»„ï¼ˆè¿™æ ·åç»­å¯ä»¥ç”¨ttæ›¿ä»£ï¼‰
        f_tensor![
            $($path).* $( [ $($arg)+ ] )+
        ]
    };
    // å…¥å£/æ•°ç»„å½¢å¼ï¼ˆå†…å¤–æ¡¥æ¢ï¼‰ | å¯é€‰é€—å·è¿›è¡Œæ— æ­§ä¹‰åˆ†éš”
    // * `f_tensor![f [1 2 3] [4 5 6]]` => ``f_tensor![[f] [] [[1, 2, 3,] [4, 5, 6,]]]``
    [
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆæ ‡è¯†ç¬¦åºåˆ—ï¼‰
        $($path:ident).+
        // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ—
        $( [ $($arg:expr $(,)? )+ ] )+
    ] => {
        // * 1 å¼€å§‹è§£æ
        f_tensor![
            // åŠ ä¸Šæ ‡è¯†ç¬¦
            @inner
            // å°†ã€Œè¢«è°ƒç”¨å‡½æ•°ã€æ‰“åŒ…ï¼ˆä»¥ä¾¿æ”¯æŒå¦‚`self.add`çš„è¡¨è¾¾å½¢å¼ï¼‰
            [$($path).+]
            // ç©ºå‚æ•°é›†ï¼ˆæœªå¼€å§‹å¡«å……ï¼‰
            []
            // åŒ…è£…ï¼š`([å‚æ•°é›†1], [å‚æ•°é›†2] ...)`
            [ $( [ $($arg,)+ ], )+ ]
        ]
    };
    // ã€å†…éƒ¨ã€‘ã€Œçº¯å‚æ•°ã€fallbackæƒ…å†µ
    // * `f_tensor![[f] [1, 2, 3,]]` => `f(1, 2, 3)`
    [
        // å†…éƒ¨æ ‡è¯†ç¬¦
        @inner
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆå·²ä½œ`[fn]`åŒ…è£…ï¼Œæ­¤å¤„è§£åŒ…ï¼‰
        [ $($f:tt)+ ]
        // åªæœ‰ä¸€ä¸ªè¡¨è¾¾å¼åºåˆ—
        [ $($arg:expr,)+ ]
    ] => {
        // ç›´æ¥è§£åŒ…
        $($f)* ($($arg),+)
    };
    // ã€å†…éƒ¨ã€‘å‚æ•°+ç©ºæ‹¬å· æƒ…å†µ
    // * `f_tensor![[f] [1, 2, 3,] []]` => `f_tensor![[f] [1, 2, 3,]]`
    [
        // å†…éƒ¨æ ‡è¯†ç¬¦
        @inner
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆå·²ä½œ`[fn]`åŒ…è£…ï¼‰
        $f:tt
        // è¡¨è¾¾å¼åºåˆ—
        $args:tt
        // ç©ºæ‹¬å·
        []
    ] => {
        // å»æ‰ç©ºæ‹¬å·
        f_tensor![@inner $f $args]
    };
    // ã€å†…éƒ¨ã€‘å‚æ•°+å‚æ•° æƒ…å†µ
    // * `f_tensor![[f] [1, 2, 3,] [[x1, x2, ...x,] ...tail]]` => `...f_tensor![[f] [1, 2, 3, x,] [...tail]]`
    [
        // å†…éƒ¨æ ‡è¯†ç¬¦
        @inner
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆå·²ä½œ`[fn]`åŒ…è£…ï¼‰
        $f:tt
        // è¡¨è¾¾å¼åºåˆ—ï¼ˆæ­¤å¤„å»¶è¿Ÿè§£åŒ…ï¼Œç•™ç»™åè¾¹çš„`append`ï¼‰
        $args_head:tt
        // [[å‚æ•°å¤´...] å…¶å®ƒå‚æ•°...]
        [ [ $($x:expr,)+ ], $($tail:tt)* ]
    ] => {
        // * è§£æ„ï¼Œç•™ç»™ä¸“é—¨çš„å‡½æ•°è¿›è¡Œå±•å¼€ï¼ˆå› ä¸ºxå’Œtailä¸èƒ½åŒæ—¶å±•å¼€ï¼‰
        f_tensor![
            // è°ƒç”¨æ–°å‡½æ•°
            @inner_expand
            // ç›´æ¥ä¼ é€’è¢«è°ƒç”¨è€…
            $f
            // ç›´æ¥ä¼ é€’è¡¨è¾¾å¼åºåˆ—ï¼ˆåç»­ã€Œå±•å¼€ã€ã€Œè¿½åŠ ã€è¦ä¸€æ¬¡å®Œæˆï¼‰
            $args_head
            // æå–xåºåˆ—
            [ $($x,)+ ]
            // å»å¤´ | å…ˆå±•å¼€tail
            [ $($tail)* ]
        ]
    };
    // * ã€å†…éƒ¨ã€‘å·¥å…·åˆ†æ´¾/å±•å¼€
    [
        // å†…éƒ¨æ ‡è¯†ç¬¦
        @inner_expand
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆå·²ä½œ`[fn]`åŒ…è£…ï¼‰
        $f:tt
        // è¡¨è¾¾å¼åºåˆ—ï¼ˆæ­¤å¤„å»¶è¿Ÿè§£åŒ…ï¼Œç•™ç»™åè¾¹çš„`append`ï¼‰
        $args_head:tt
        // æå–çš„xåºåˆ—ï¼ˆé¢„å¤‡å±•å¼€ï¼‰
        [ $($x:expr,)+ ]
        // (å…¶å®ƒå‚æ•°...)
        $other_args:tt
    ] => {
        // * å¼€å§‹ã€å±•å¼€ã€‘ä¸€ä¸ªç»´åº¦
        [
            $(f_tensor![
                // åœ¨å±•å¼€ä¹‹åä¸“é—¨è¿½åŠ 
                @inner_append
                // ç›´æ¥ä¼ é€’è¢«è°ƒç”¨è€…
                $f
                // è¡¨è¾¾å¼åºåˆ—åŸæ ·ä¼ é€’
                $args_head
                // ! è¿™é‡Œä¸èƒ½ã€Œå®å¥—å®ã€ï¼šã€Œè¡¨ç¤ºã€è¿½åŠ ã€çš„å®è°ƒç”¨ã€è¢«è®¤æˆè¡¨è¾¾å¼äº†
                // f_tensor!( @append $args_head $x )
                [ $x ] // æå–å‡ºæ¥çš„x
                // ç•™ä¸‹çš„å°¾éƒ¨åºåˆ—
                $other_args
            ]),+
        ]
    };
    // * ã€å†…éƒ¨ã€‘å·¥å…·åˆ†æ´¾/è¿½åŠ 
    [
        // å†…éƒ¨æ ‡è¯†ç¬¦
        @inner_append
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆå·²ä½œ`[fn]`åŒ…è£…ï¼‰
        $f:tt
        // è¡¨è¾¾å¼åºåˆ—ï¼ˆæ­¤å¤„è§£åŒ…ï¼‰
        [ $($arg_head:expr,)* ]
        // æå–çš„x
        [ $x:expr ]
        // (å…¶å®ƒå‚æ•°...)
        $other_args:tt
    ] => {
        f_tensor![
            // å›åˆ°åŸå…ˆçš„å±•å¼€è¿›ç¨‹
            @inner
            // ç›´æ¥ä¼ é€’è¢«è°ƒç”¨è€…
            $f
            // å±•å¼€çš„å‚æ•°ã€è¿½åŠ ã€‘åˆ°å‡½æ•°å‚æ•°åºåˆ—ä¸­
            [ $($arg_head,)* $x, ]
            // ç•™ä¸‹çš„å°¾éƒ¨åºåˆ—
            $other_args
        ]
    };
}

/// å¹³è¡Œå°†å‚æ•°å¡«å……è¿›å‡½æ•°
/// * ğŸ“„å½¢å¼ï¼š`f_parallel![add3; 1 2 3; 4 5 6]` => `[add3(1, 2, 3), add3(4, 5, 6)]`
///
/// # Example
///
/// ```rust
/// use enum_narsese::f_parallel;
/// fn add3(a: i32, b: i32, c: i32) -> i32 {
///     a + b + c
/// }
/// let m = f_parallel![
///     add3;
///     1 2 3; // add3(1, 2, 3)
///     4 5 6; // add3(4, 5, 6)
///     7, (8) 9; // add3(7, 8, 9) // ! ğŸ“Œæ­¤å¤„ä½¿ç”¨é€—å·é¿å…ã€Œè°ƒç”¨æ­§ä¹‰ã€`7(8)`
/// ];
/// assert_eq!(m, [6, 15, 24]);
/// ```
///
#[macro_export]
macro_rules! f_parallel {
    // å…¥å£/ç©ºæ ¼åˆ†å·å½¢å¼ | å¯é€‰é€—å·è¿›è¡Œæ— æ­§ä¹‰åˆ†éš”
    [
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆæ ‡è¯†ç¬¦ï¼‰
        $($path:ident).+;
        // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ— // ! â†“æ­¤å¤„å¿…é¡»é™åˆ¶ä¸ºã€Œ+ã€ï¼Œä¸ç„¶æ— æ³•å®ç°ã€Œå°¾ååˆ†å·ã€ï¼ˆä¼šå¼•å‘è§£ææ­§ä¹‰ï¼‰
        $( $( $arg:expr $(,)? )+ );* $(;)?
    ] => {
        // * ğŸš©å…ˆå°è£…å¥½ï¼š`f_parallel![add3; 1 2 3; 4 5 6]` => `f_parallel![@inner [add3] [1, 2, 3,] [4, 5, 6,]]`
        f_parallel![
            // å†…éƒ¨æ ‡è¯†ç¬¦
            @inner
            // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆæ ‡è¯†ç¬¦åºåˆ—ï¼‰
            [$($path).+]
            // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ—
            $( [ $($arg,)* ] )*
        ]
    };
    // ã€å†…éƒ¨ã€‘å…ˆå±•å¼€å‚æ•°
    // * `f_parallel![@inner [add3] [1, 2, 3,] [4, 5, 6,]]` => `f_parallel![@inner [add3] [1, 2, 3,] [4, 5, 6,]]`
    [
        @inner
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆæ ‡è¯†ç¬¦ï¼‰
        $f:tt
        // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ—çš„åºåˆ—
        $( [ $($arg:expr,)* ] )*
    ] => {
        [
            $(f_parallel![
                // å†…éƒ¨æ ‡è¯†ç¬¦
                @inner_expand
                // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆå·²ä½œ`[fn]`åŒ…è£…ï¼‰
                $f
                // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ—
                [ $($arg,)+ ]
            ]),+
        ]
    };
    // ã€å†…éƒ¨ã€‘å†å±•å¼€å‡½æ•°è¡¨è¾¾å¼
    [
        @inner_expand
        // è¦è¢«è°ƒç”¨çš„å‡½æ•°ï¼ˆæ ‡è¯†ç¬¦ï¼‰
        [ $($f:tt)* ]
        // å‚æ•°çš„è¡¨è¾¾å¼åºåˆ—
        [ $($arg:expr,)* ]
    ] => {
        $($f)* ($($arg),+)
    };
}
