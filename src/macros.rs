/// # `first!`ï¼šåŒ¹é…é¦–ä¸ªåˆ¤æ®ï¼Œå¹¶è¿”å›žå…¶å€¼
/// * ðŸŽ¯ç”¨äºŽç®€å†™ã€Œæˆªæ–­æ€§åˆ¤æ–­ã€ç»“æž„
///   * ðŸ“Œå¯ç”¨äºŽç®€å†™`if-else if-else`ã€Œä¼˜å…ˆåˆ†æ”¯ã€ç»“æž„
///   * ðŸ“Œå¯ç”¨äºŽç®€å†™`match 0 {_ if XXX => Z1, _ if YYY => Z2, _ => ELSE}`ã€Œä¼ªä¼˜å…ˆåˆ†æ”¯ã€ç»“æž„
///
/// ðŸ“Rustçš„ã€Œè§„åˆ™å®ã€å¹¶ä¸èƒ½è¢«è§†ä½œä¸ºä¸€ä¸ªç±»ä¼¼ã€Œå˜é‡ã€ã€Œå‡½æ•°ã€ä¹‹ç±»èƒ½å¯¼å‡ºçš„é‡
/// * âŒæ— æ³•ä½¿ç”¨å¸¸è§„çš„`pub`ï¼ˆç›¸å½“äºŽJuliaçš„`export`ï¼‰å¯¼å‡º
///   * ðŸ“Œéœ€è¦ä½¿ç”¨`#[macro_export]`å¯¼å‡º
///     * ðŸ“å¯é€‰çš„[`local_inner_macros`]ï¼šå¯¼å‡ºåœ¨å½“å‰æ¨¡å—ä¸­å®šä¹‰çš„ã€Œå†…éƒ¨å®ã€(inner macro)ã€‚
///       * å†…éƒ¨å®ï¼šä»…åœ¨å…¶ä»–å®çš„å®šä¹‰ä½“ä¸­ä½¿ç”¨çš„å®
/// * â—éœ€è¦åœ¨crateå±‚çº§å¯¼å…¥ï¼Œè€Œéžåœ¨å®šä¹‰å®çš„æ¨¡å—ä¸­å¯¼å…¥
/// * ðŸ“ä½¿ç”¨`#[cfg(not(test))]`æ ‡æ³¨ã€Œéžæµ‹è¯•ã€
///   * ðŸŽ¯å¯é˜²æ­¢ã€Œå®šä¹‰ä¹‹å‰æµ‹è¯•å®ã€å¯¼è‡´çš„ã€Œæ–‡æ¡£æµ‹è¯•ï¼ˆdoc testï¼‰å¤±è´¥ã€
///   * â—ä½†ä¹Ÿä¼šå¯¼è‡´åœ¨åˆ«çš„æµ‹è¯•ä¸­ç”¨ä¸äº†
///   * ðŸ“ŒSOLUTIONï¼šåœ¨æ–‡æ¡£ä»£ç å—ä¸­å¼•å…¥`use ã€åº“åã€‘::*;`
///     * â—ä¸èƒ½ç”¨`crate` | `help: consider importing this macro`
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::first;
/// fn see(v: &str) -> &str {
///     // åŒ¹é…ä¸€ä¸ªæ— æ„ä¹‰çš„å€¼ï¼Œä½¿ç”¨åŒ¹é…å®ˆå«æ¥ç¡®å®šã€Œå”¯ä¸€è¿›å…¥çš„åˆ†æ”¯ã€
///     first! {
///         v.is_empty() => "ç©ºçš„ï¼",
///         v.starts_with("0") => "ä»¥é›¶å¼€å¤´ï¼",
///         v.starts_with("1") => "ä»¥ä¸€å¼€å¤´ï¼",
///         v.starts_with("2") => "ä»¥äºŒå¼€å¤´ï¼",
///         v.len() > 5 => "è¶…é•¿å­—ç¬¦ä¸²ï¼",
///         v.starts_with("3") => "ä»¥ä¸‰å¼€å¤´ï¼",
///         _ => "è¿™å•¥çŽ©æ„â€¦",
///     }
/// }
/// ```
///
/// å°†è¢«è½¬æ¢æˆ
///
/// ```rust
/// fn see(v: &str) -> &str {
///    match 0 {
///         _ if v.is_empty() => "ç©ºçš„ï¼",
///         _ if v.starts_with("0") => "ä»¥é›¶å¼€å¤´ï¼",
///         _ if v.starts_with("1") => "ä»¥ä¸€å¼€å¤´ï¼",
///         _ if v.starts_with("2") => "ä»¥äºŒå¼€å¤´ï¼",
///         _ if v.len() > 5 => "è¶…é•¿å­—ç¬¦ä¸²ï¼",
///         _ if v.starts_with("3") => "ä»¥ä¸‰å¼€å¤´ï¼",
///         _ => "è¿™å•¥çŽ©æ„â€¦",
///     }
/// }
/// ```
///
/// æ­¤`match`è¡¨è¾¾å¼ç­‰ä»·äºŽï¼š
///
/// ```rust
/// fn see(v: &str) -> &str {
///     if v.is_empty() {
///        "ç©ºçš„ï¼"
///     } else if v.starts_with("0") {
///         "ä»¥é›¶å¼€å¤´ï¼"
///     } else if v.starts_with("1") {
///         "ä»¥ä¸€å¼€å¤´ï¼"
///     } else if v.starts_with("2") {
///         "ä»¥äºŒå¼€å¤´ï¼"
///     } else if v.len() > 5 {
///         "è¶…é•¿å­—ç¬¦ä¸²ï¼"
///     } else if v.starts_with("3") {
///         "ä»¥ä¸‰å¼€å¤´ï¼"
///     } else {
///         "è¿™å•¥çŽ©æ„â€¦"
///     }
/// }
/// ```
#[macro_export]
macro_rules! first {
    // ç¬¬ä¸€æ¡è§„åˆ™ï¼šæœ€åŽä¸€æ¡ä¿ç•™`_`
    { // * ðŸ“â†å·¦è¾¹çš„æ‹¬å·åªæ˜¯æ ‡æ³¨ã€ŒæŽ¨èç”¨æ‹¬å¼§ã€è€Œå¯¹å®žé™…è§£æžæ— é™å®šä½œç”¨
        // â†“å‰è¾¹æ ‡æ³¨ç‰‡æ®µä»¥ã€Œ,ã€é‡å¤    åŽè¾¹åˆ†éš”è¡¨è¾¾å¼â†“
        $($guardian:expr => $value:expr),* ,
        // â†“å¯¹å­—é¢æ ‡è¯†ã€Œ_ã€æ— éœ€`$(...)`å¼•ç”¨
        _ => $value_else:expr $(,)?
    } => {
        // ðŸ’­å®žé™…ä¸Šè½¬æ¢ä¸º`if-else if-else`äº¦éžä¸å¯
        // åŒ¹é…æ— ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡`0`
        match 0 {
            // â†“è¿™ä¸€è¡Œæ’å…¥åºåˆ—
            $(_ if $guardian => $value,)*
            _ => $value_else,
        }
    }; // ! â†è®°å¾—åˆ†å·åˆ†éš”
    // ã€Œæœ€åŽä¸€æ¡ç›´æŽ¥å†™ã€çš„è§„åˆ™ä¼šå¯¼è‡´ã€Œè¡¨è¾¾å¼æ­§ä¹‰ã€
    // ðŸ“„``local ambiguity when calling macro `first`: multiple parsing options: built-in NTs expr ('value_else') or expr ('guardian').``
}

/// # `show!`ï¼šå¤çŽ°Juliaçš„`@show`
/// * ðŸŽ¯æ¨¡æ‹ŸJuliaä¸­å¸¸ç”¨çš„å®`@show è¡¨è¾¾å¼`
///   * ä¸ŽJulia`@show(è¡¨è¾¾å¼)`ç­‰ä»· | Juliaçš„è¿˜æ›´å®½æ¾ï¼Œä¸å¼ºåˆ¶æ‹¬å·
/// * ðŸ“Œæ ¸å¿ƒï¼šæ‰“å°`è¡¨è¾¾å¼ = å€¼`ï¼Œå¹¶è¿”å›žè¡¨è¾¾å¼çš„å€¼
/// * ðŸ“ä½¿ç”¨`#[cfg(not(test))]`æ ‡æ³¨ã€Œéžæµ‹è¯•ã€
///   * ðŸŽ¯é˜²æ­¢ã€Œå®šä¹‰ä¹‹å‰æµ‹è¯•å®ã€å¯¼è‡´çš„ã€Œæ–‡æ¡£æµ‹è¯•ï¼ˆdoc testï¼‰å¤±è´¥ã€
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::show;
/// fn see(v: &str) -> &str {
///     // ç”¨`@show`æ‰“å°`v`ï¼Œå¹¶è¿”å›žå…¶å€¼
///     show!(v)
/// }
/// ```
///
/// å°†è¢«è½¬æ¢ä¸º
///
/// ```rust
/// fn see(v: &str) -> &str {
///     // ç”¨`@show`æ‰“å°`v`ï¼Œå¹¶è¿”å›žå…¶å€¼
///     {
///         let value = v;
///         println!("{} = {:?}", "v", value);
///         value
///     }
/// }
/// ```
///
/// è°ƒç”¨`see("æˆ‘æ˜¯ä¸€ä¸ªå€¼")`å°†è¾“å‡º
///
/// ```plaintext
/// v = "æˆ‘æ˜¯ä¸€ä¸ªå€¼"
/// ```
///
/// å¹¶è¿”å›ž`"æˆ‘æ˜¯ä¸€ä¸ªå€¼"`
#[macro_export]
macro_rules! show {
    ($v:expr) => {
        // è¿”å›žä¸€ä¸ªã€Œå¤šè¡Œä»£ç è¡¨è¾¾å¼ã€
        {
            let value = $v;
            println!("{} = {:?}", stringify!($v), value);
            value
        }
    };
}

/// # è¾…åŠ©ç”¨æµ‹è¯•å®/æ‰¹é‡æ·»åŠ å¤±è´¥æµ‹è¯•
///
/// * å¯æžå¤§å‡è½»æ·»åŠ `should_panic`çš„ä»£ç é‡
///
/// ! ðŸ“`, $(,)?`è¿™é‡Œçš„ã€Œ,ã€ä»£è¡¨çš„ä¸æ˜¯ã€Œåˆ†éš”è¡¨è¾¾å¼ã€ï¼Œè€Œæ˜¯ã€Œæ¨¡å¼ä¸­çš„`,`ã€
/// * æ•…åº”åŽ»é™¤è¿™å‰è¾¹çš„ã€Œ,ã€
///
/// ç”¨æ³•ï¼š
///
/// ```rust
/// use enum_narsese::fail_tests;
/// // ä¸€èˆ¬å½¢å¼ï¼šå‡½æ•°å {ä»£ç }
/// fail_tests! {
///     å¤±è´¥æµ‹è¯•çš„å‡½æ•°å {
///         // ä¼šå¯¼è‡´panicçš„ä»£ç 
///     }
///     // ... å…è®¸å¤šæ¡
/// }
/// // äº¦å¯ï¼šå‡½æ•°å è¡¨è¾¾å¼/è¯­å¥
/// fail_tests! {
///     å¤±è´¥æµ‹è¯•çš„å‡½æ•°å if true {panic!("ä¼šå¯¼è‡´panicçš„è¡¨è¾¾å¼")} else {};
///     // ... å…è®¸å¤šæ¡
/// }
/// fail_tests! {
///     å¤±è´¥æµ‹è¯•çš„å‡½æ•°å panic!("ä¼šå¯¼è‡´panicçš„è¯­å¥");
///     // ... å…è®¸å¤šæ¡
/// }
/// ```
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::fail_tests;
/// fail_tests! {
///     fail {
///         panic!("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•")
///     }
///     fail2 {
///         panic!("è¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•")
///     }
/// }
/// ```
///
/// å°†è¢«è½¬æ¢ä¸º
///
/// ```rust
/// #[test]
/// #[should_panic]
/// fn fail() {
///     panic!("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•")
/// }
///
/// #[test]
/// #[should_panic]
/// fn fail2() {
///     panic!("è¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•")
/// }
/// ```
#[macro_export]
macro_rules! fail_tests {
    // åŒ¹é…ä»£ç å—
    ($($name:ident $code:block)* $(,)?) => {
        $(
            /// å¤±è´¥æµ‹è¯•_$name
            #[test]
            #[should_panic]
            fn $name() {
                $code
            }
        )*
    };
    // åŒ¹é…è¡¨è¾¾å¼
    ($($name:ident $code:expr;)* $(,)?) => {
        $(
            /// å¤±è´¥æµ‹è¯•_$name
            #[test]
            #[should_panic]
            fn $name() {
                $code; // â† ç”¨åˆ†å·åˆ†éš”
            }
        )*
    };
    // åŒ¹é…è¯­å¥
    ($($name:ident $code:stmt;)* $(,)?) => {
        $(
            /// å¤±è´¥æµ‹è¯•_$name
            #[test]
            #[should_panic]
            fn $name() {
                $code
            }
        )*
    };
}

/// ç”¨äºŽç®€åŒ–ã€Œè¿žç»­è¿½åŠ å­—ç¬¦ä¸²ã€çš„å®
/// * ðŸŽ¯æœ€åˆç”¨äºŽã€Œå­—ç¬¦ä¸²æ ¼å¼åŒ–ã€ç®—æ³•ä¸­
/// * ðŸš©ç”¨æ³•ï¼š`push_str!(è¦è¿½åŠ å…¥çš„å­—ç¬¦ä¸²; å¾…è¿½åŠ è¡¨è¾¾å¼1, å¾…è¿½åŠ è¡¨è¾¾å¼2, ...)`
///
/// ## ç”¨ä¾‹
///
/// ```rust
/// use enum_narsese::push_str;
/// let mut s = String::new();
/// push_str!(
///     &mut s;
///     "è¿™",
///     "æ˜¯",
///     "å¯ä»¥è¢«",
///     &String::from("è¿žç»­æ·»åŠ "),
///     "\u{7684}",
/// );
/// assert_eq!(s, "è¿™æ˜¯å¯ä»¥è¢«è¿žç»­æ·»åŠ çš„");
/// ```
#[macro_export]
macro_rules! push_str {
    {$out:expr; $($ex:expr),* $(,)?} => {
        {
            $(
                $out.push_str($ex)
            );*
        }
    };
}

/// ç”¨äºŽå°†ã€Œæµå¼è¿½åŠ ã€æ•æ‰è½¬æ¢æˆã€Œå›ºå®šè¿”å›žå€¼ã€
/// * ðŸŽ¯é¦–æ¬¡åº”ç”¨äºŽã€ŒåŸºäºŽ[`String::push_str`]åŠ¨æ€è¿½åŠ äº§ç”Ÿå­—ç¬¦ä¸²ã€ä¸Žã€Œç›´æŽ¥è¿”å›žå­—ç¬¦ä¸²ã€çš„è½¬æ¢ä¸­
/// 
/// # Example
///
/// ```rust
/// use enum_narsese::catch_flow;
///
/// fn append(out: &mut String) {
///     out.push_str("hello, ");
///     out.push_str("world!");
/// }
/// 
/// let caught = catch_flow!(append;);
/// assert_eq!(caught, "hello, world!");
/// ```
#[macro_export]
macro_rules! catch_flow {
    ( $($path:ident).+ ; $($arg:tt)* ) => {
        {
            let mut s = String::new();
            $($path).+(&mut s, $($arg)*);
            s
        }
    };
}
